# Auto-Updates Implementation Guide

**Internal document - not linked from public documentation**

---

## Overview

The main Electron desktop app (ProPresenter Lyrics) supports automatic updates via `electron-updater`. When a new version is published to GitHub Releases, the app detects it, offers to download, and can restart to install.

## How It Works

```
App Launch
  ↓ (3 second delay)
Check GitHub Releases for latest.yml / latest-mac.yml
  ↓
Compare version in yml against app.getVersion()
  ↓
If newer → Show "Update Available" banner in UI
  ↓
User clicks "Download Update" → Download in background with progress bar
  ↓
Download complete → Show "Restart & Update" button
  ↓
User clicks → quitAndInstall() restarts the app with the new version
```

## Key Files

| File | What it does |
|---|---|
| `electron-builder.config.js` | `publish` config pointing to GitHub repo |
| `electron/main/index.ts` | Auto-updater initialization, IPC handlers, event forwarding |
| `electron/preload/index.ts` | Exposes updater API to renderer (check, download, install, events) |
| `electron/renderer/src/App.tsx` | Update banner UI (available → downloading → ready) |
| `electron/renderer/src/styles.css` | `.update-banner` styles |
| `.github/workflows/release.yml` | Publishes `latest.yml` and `latest-mac.yml` alongside release assets |

## Configuration

### electron-builder.config.js

```js
publish: {
  provider: 'github',
  owner: 'adamswbrown',
  repo: 'propresenterlyricexport',
},
```

This tells electron-builder to generate `latest.yml` (Windows) and `latest-mac.yml` (macOS) metadata files during packaging. These files contain the version number, filename, file size, and sha512 hash that `electron-updater` uses to check for and verify updates.

### Main Process Settings

```typescript
autoUpdater.autoDownload = false;       // User must opt-in to download
autoUpdater.autoInstallOnAppQuit = true; // Install pending update when app quits
```

## IPC Channels

### Invoke (renderer → main → response)

| Channel | Purpose | Returns |
|---|---|---|
| `updater:check` | Manually check for updates | `{ success, version?, error? }` |
| `updater:download` | Start downloading the update | `{ success, error? }` |
| `updater:install` | Quit and install the update | void (app restarts) |
| `updater:get-version` | Get current app version | `string` |

### Events (main → renderer, push-based)

| Channel | When | Payload |
|---|---|---|
| `updater:update-available` | New version found | `{ version, releaseNotes }` |
| `updater:update-not-available` | Already on latest | none |
| `updater:download-progress` | During download | `{ percent, bytesPerSecond, transferred, total }` |
| `updater:update-downloaded` | Download complete | none |
| `updater:error` | Something failed | `string` (error message) |

## UI States

The update banner appears at the top of the app with three states:

1. **Update Available** - Shows version number, "Download Update" and "Dismiss" buttons
2. **Downloading** - Shows percentage and progress bar
3. **Ready to Install** - Shows "Restart & Update" and "Later" buttons

The banner can be dismissed. It won't reappear until the next app launch (when it auto-checks again).

The Settings modal also has an "About" section at the bottom showing the current version and a "Check for Updates" button for manual checks.

## GitHub Actions Integration

The release workflow (`.github/workflows/release.yml`) was updated to:

1. **macOS job**: After packaging, copies `release/latest-mac.yml` into the artifacts directory (if it exists)
2. **Windows job**: After packaging, copies `release/latest.yml` into the artifacts directory (if it exists)
3. **Publish job**: Includes `dist/latest.yml` and `dist/latest-mac.yml` in the GitHub Release upload alongside the `.zip` and `.exe` files

The yml files are generated by electron-builder when the `publish` config exists in `electron-builder.config.js`, even when building with `--publish=never`.

## Code Signing (Required for Production)

### Current Status: Not Signed

Auto-updates work differently depending on code signing status:

### macOS

- **Without signing**: `electron-updater` will fail to verify downloaded updates. Users will see "app is damaged" warnings from Gatekeeper.
- **With signing**: Updates download, verify, and install seamlessly.

**Requirements:**
- Apple Developer account ($99/year)
- Developer ID Application certificate
- Notarization (Apple scans the app)

**Environment variables for CI:**
```bash
CSC_LINK=path/to/certificate.p12      # or base64-encoded cert
CSC_KEY_PASSWORD=your-password

# For notarization:
APPLE_ID=your@email.com
APPLE_APP_SPECIFIC_PASSWORD=xxxx-xxxx-xxxx-xxxx
APPLE_TEAM_ID=XXXXXXXXXX
```

electron-builder handles signing and notarization automatically when these env vars are set. Store them as GitHub repository secrets.

### Windows

- **Without signing**: Updates still work. Users see SmartScreen warnings on first install ("Windows protected your PC"). After enough installs, SmartScreen learns to trust it.
- **With signing**: No SmartScreen warnings. Clean install experience.

**Requirements:**
- Code signing certificate from a CA (DigiCert, Sectigo, etc.) - $200-400/year
- Or an EV certificate (hardware token) for immediate SmartScreen trust

**Environment variables for CI:**
```bash
CSC_LINK=path/to/certificate.pfx
CSC_KEY_PASSWORD=your-password
```

### Recommended Approach

1. **Phase 1**: Ship without signing. Windows auto-updates work. macOS users download manually from GitHub Releases.
2. **Phase 2**: Get Apple Developer certificate. Enable macOS auto-updates + notarization.
3. **Phase 3** (optional): Get Windows code signing cert to remove SmartScreen warnings.

## Dependencies

| Package | Version | Purpose |
|---|---|---|
| `electron-updater` | latest | Auto-update checking, downloading, installing |
| `electron-log` | latest | Logging for updater diagnostics |

Both are listed in `package.json` dependencies (not devDependencies) because they're needed at runtime in the packaged app.

## Troubleshooting

### Updates not detected
- Verify `latest.yml` / `latest-mac.yml` exists in the GitHub Release assets
- Check the version in `package.json` is lower than the release version
- Look at electron-log output (on macOS: `~/Library/Logs/ProPresenter Lyrics/main.log`)

### Download fails
- Check network connectivity
- Verify the release assets (`.zip` / `.exe`) are publicly accessible
- For private repos, ensure `GH_TOKEN` is configured

### "App is damaged" on macOS
- The app is not code-signed. This is expected without an Apple Developer certificate.
- Users can bypass with: right-click → Open (first launch only)
- Proper fix: sign the app with a Developer ID certificate

### Update installs but app won't launch
- Check if the new version has a breaking dependency
- Look at crash logs in Console.app (macOS) or Event Viewer (Windows)

## Multi-App Considerations

The project has three Electron apps. Currently only the **main app** (ProPresenter Lyrics) has auto-updates configured. The Viewer and Proxy apps do not.

To add auto-updates to Viewer or Proxy:
1. Add `publish` config to their respective `electron-builder.config.js` files
2. Use different `appId` values (already set)
3. Each would need its own `latest.yml` / `latest-mac.yml` in the release
4. Consider whether they should share version numbers or have independent versioning
