name: Release Desktop Builds

on:
  push:
    tags:
      - 'v*'
      - '[0-9]*'
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: 20

jobs:
  macos:
    name: macOS Apps
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      # ── Main App ──
      - name: Build main app bundles
        run: npm run electron:build

      - name: Package main app (macOS zip)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --mac zip --publish=never --config electron-builder.config.js

      # ── Viewer App ──
      - name: Build viewer app bundles
        run: npm run viewer:build

      - name: Package viewer app (macOS zip)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --mac zip --publish=never --config viewer-app/electron-builder.config.js

      # ── Web Proxy App ──
      - name: Build web server executable (macOS)
        run: |
          npm run build
          npm run web:build:ui
          mkdir -p executables
          npx pkg --config package.json dist/server/web-server.js --output executables/pp-web-server --targets node18-macos-arm64 --options max-old-space-size=4096

      - name: Build proxy app bundles
        run: npm run proxy:build

      - name: Package proxy app (macOS zip)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --mac zip --publish=never --config proxy-app/electron-builder.config.js

      # ── Collect artifacts ──
      - name: Prepare macOS artifacts
        run: |
          mkdir -p artifacts

          # Main app — versioned from package.json (e.g. ProPresenter-Lyrics-3.0.0-mac.zip)
          MAIN=$(find release -maxdepth 1 -name 'ProPresenter-Lyrics-*-mac.zip' | head -n 1)
          if [ -z "$MAIN" ] || [ ! -f "$MAIN" ]; then
            echo "::error::Main app macOS zip not found in release/"
            ls -R release || true
            exit 1
          fi
          cp "$MAIN" artifacts/

          # Viewer app — own version (e.g. ProPresenter-Viewer-1.0.0-mac.zip)
          VIEWER=$(find release-viewer -maxdepth 1 -name 'ProPresenter-Viewer-*-mac.zip' | head -n 1)
          if [ -z "$VIEWER" ] || [ ! -f "$VIEWER" ]; then
            echo "::error::Viewer app macOS zip not found in release-viewer/"
            ls -R release-viewer || true
            exit 1
          fi
          cp "$VIEWER" artifacts/

          # Proxy app — own version (e.g. ProPresenter-WebProxy-1.0.0-mac.zip)
          PROXY=$(find release-proxy -maxdepth 1 -name 'ProPresenter-WebProxy-*-mac.zip' | head -n 1)
          if [ -z "$PROXY" ] || [ ! -f "$PROXY" ]; then
            echo "::error::Proxy app macOS zip not found in release-proxy/"
            ls -R release-proxy || true
            exit 1
          fi
          cp "$PROXY" artifacts/

          echo "macOS artifacts:"
          ls -lh artifacts/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-apps
          path: artifacts/*
          retention-days: 7

  windows:
    name: Windows Apps
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      # ── Main App ──
      - name: Build main app bundles
        run: npm run electron:build

      - name: Package main app (Windows exe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win nsis --publish=never --config electron-builder.config.js

      # ── Viewer App ──
      - name: Build viewer app bundles
        run: npm run viewer:build

      - name: Package viewer app (Windows exe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win nsis --publish=never --config viewer-app/electron-builder.config.js

      # ── Web Proxy App ──
      - name: Build web server executable (Windows)
        run: |
          npm run build
          npm run web:build:ui
          if (!(Test-Path -Path executables)) { New-Item -ItemType Directory -Force -Path executables | Out-Null }
          npx pkg --config package.json dist/server/web-server.js --output executables/pp-web-server --targets node18-win-x64 --options max-old-space-size=4096
        shell: pwsh

      - name: Build proxy app bundles
        run: npm run proxy:build

      - name: Package proxy app (Windows exe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win nsis --publish=never --config proxy-app/electron-builder.config.js

      # ── Collect artifacts ──
      - name: Prepare Windows artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null

          # Main app
          $main = Get-ChildItem -Path release -Filter 'ProPresenter-Lyrics-*-win.exe' | Select-Object -First 1
          if (-not $main) { throw 'Main app installer not found in release/' }
          Copy-Item $main.FullName "artifacts/$($main.Name)" -Force

          # Viewer app
          $viewer = Get-ChildItem -Path release-viewer -Filter 'ProPresenter-Viewer-*-win.exe' | Select-Object -First 1
          if (-not $viewer) { throw 'Viewer app installer not found in release-viewer/' }
          Copy-Item $viewer.FullName "artifacts/$($viewer.Name)" -Force

          # Proxy app
          $proxy = Get-ChildItem -Path release-proxy -Filter 'ProPresenter-WebProxy-*-win.exe' | Select-Object -First 1
          if (-not $proxy) { throw 'Proxy app installer not found in release-proxy/' }
          Copy-Item $proxy.FullName "artifacts/$($proxy.Name)" -Force

          Write-Host "Windows artifacts:"
          Get-ChildItem artifacts/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-apps
          path: artifacts/*
          retention-days: 7

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - macos
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-apps
          path: dist

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-apps
          path: dist

      - name: List release assets
        run: ls -lh dist/

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          files: |
            dist/ProPresenter-Lyrics-*-mac.zip
            dist/ProPresenter-Lyrics-*-win.exe
            dist/ProPresenter-Viewer-*-mac.zip
            dist/ProPresenter-Viewer-*-win.exe
            dist/ProPresenter-WebProxy-*-mac.zip
            dist/ProPresenter-WebProxy-*-win.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
