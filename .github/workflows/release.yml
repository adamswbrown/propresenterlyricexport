name: Release Desktop Builds

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: 20

jobs:
  macos:
    name: macOS Apps
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      # â”€â”€ Main App â”€â”€
      - name: Build main app bundles
        run: npm run electron:build

      - name: Package main app (macOS zip)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --mac zip --publish=never --config electron-builder.config.js

      # â”€â”€ Viewer App â”€â”€
      - name: Build viewer app bundles
        run: npm run viewer:build

      - name: Package viewer app (macOS zip)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --mac zip --publish=never --config viewer-app/electron-builder.config.js

      # â”€â”€ Web Proxy App â”€â”€
      - name: Build web server executable (macOS)
        run: |
          npm run build
          npm run web:build:ui
          mkdir -p executables
          npx pkg --config package.json dist/server/web-server.js --output executables/pp-web-server --targets node18-macos-arm64 --options max-old-space-size=4096

      - name: Build proxy app bundles
        run: npm run proxy:build

      - name: Package proxy app (macOS zip)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --mac zip --publish=never --config proxy-app/electron-builder.config.js

      # â”€â”€ Collect artifacts â”€â”€
      - name: Prepare macOS artifacts
        run: |
          mkdir -p artifacts

          # Main app â€” versioned from package.json (e.g. ProPresenter-Lyrics-3.0.0-mac.zip)
          MAIN=$(find release -maxdepth 1 -name 'ProPresenter-Lyrics-*-mac.zip' | head -n 1)
          if [ -z "$MAIN" ] || [ ! -f "$MAIN" ]; then
            echo "::error::Main app macOS zip not found in release/"
            ls -R release || true
            exit 1
          fi
          cp "$MAIN" artifacts/

          # Viewer app â€” own version (e.g. ProPresenter-Viewer-1.0.0-mac.zip)
          VIEWER=$(find release-viewer -maxdepth 1 -name 'ProPresenter-Viewer-*-mac.zip' | head -n 1)
          if [ -z "$VIEWER" ] || [ ! -f "$VIEWER" ]; then
            echo "::error::Viewer app macOS zip not found in release-viewer/"
            ls -R release-viewer || true
            exit 1
          fi
          cp "$VIEWER" artifacts/

          # Proxy app â€” own version (e.g. ProPresenter-WebProxy-1.0.0-mac.zip)
          PROXY=$(find release-proxy -maxdepth 1 -name 'ProPresenter-WebProxy-*-mac.zip' | head -n 1)
          if [ -z "$PROXY" ] || [ ! -f "$PROXY" ]; then
            echo "::error::Proxy app macOS zip not found in release-proxy/"
            ls -R release-proxy || true
            exit 1
          fi
          cp "$PROXY" artifacts/

          echo "macOS artifacts:"
          ls -lh artifacts/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-apps
          path: artifacts/*
          retention-days: 7

  windows:
    name: Windows Apps
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      # â”€â”€ Main App â”€â”€
      - name: Build main app bundles
        run: npm run electron:build

      - name: Package main app (Windows exe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win nsis --publish=never --config electron-builder.config.js

      # â”€â”€ Viewer App â”€â”€
      - name: Build viewer app bundles
        run: npm run viewer:build

      - name: Package viewer app (Windows exe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win nsis --publish=never --config viewer-app/electron-builder.config.js

      # â”€â”€ Web Proxy App â”€â”€
      - name: Build web server executable (Windows)
        run: |
          npm run build
          npm run web:build:ui
          if (!(Test-Path -Path executables)) { New-Item -ItemType Directory -Force -Path executables | Out-Null }
          npx pkg --config package.json dist/server/web-server.js --output executables/pp-web-server --targets node18-win-x64 --options max-old-space-size=4096
        shell: pwsh

      - name: Build proxy app bundles
        run: npm run proxy:build

      - name: Package proxy app (Windows exe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win nsis --publish=never --config proxy-app/electron-builder.config.js

      # â”€â”€ Collect artifacts â”€â”€
      - name: Prepare Windows artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null

          # Main app
          $main = Get-ChildItem -Path release -Filter 'ProPresenter-Lyrics-*-win.exe' | Select-Object -First 1
          if (-not $main) { throw 'Main app installer not found in release/' }
          Copy-Item $main.FullName "artifacts/$($main.Name)" -Force

          # Viewer app
          $viewer = Get-ChildItem -Path release-viewer -Filter 'ProPresenter-Viewer-*-win.exe' | Select-Object -First 1
          if (-not $viewer) { throw 'Viewer app installer not found in release-viewer/' }
          Copy-Item $viewer.FullName "artifacts/$($viewer.Name)" -Force

          # Proxy app
          $proxy = Get-ChildItem -Path release-proxy -Filter 'ProPresenter-WebProxy-*-win.exe' | Select-Object -First 1
          if (-not $proxy) { throw 'Proxy app installer not found in release-proxy/' }
          Copy-Item $proxy.FullName "artifacts/$($proxy.Name)" -Force

          Write-Host "Windows artifacts:"
          Get-ChildItem artifacts/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-apps
          path: artifacts/*
          retention-days: 7

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - macos
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-apps
          path: dist

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-apps
          path: dist

      - name: List release assets
        run: ls -lh dist/

      - name: Generate release notes
        run: |
          TAG=${GITHUB_REF_NAME:-v3.0.0}
          DOCS_URL="https://adamswbrown.github.io/propresenterlyricexport"

          cat > release-notes.md << 'NOTES_EOF'
          # ProPresenter Lyrics Export v3.0.0

          **Three apps, one ecosystem** â€” everything you need to run ProPresenter lyrics for your church, from the production booth to every seat in the house and beyond.

          ---

          ## What's New in v3.0.0

          ### ğŸ–¥ï¸ Desktop App â€” ProPresenter Lyrics v3.0.0

          The app you know and love, now part of the v3 family. Export lyrics from ProPresenter playlists to PowerPoint, generate service playlists from PDFs, and manage your worship library â€” all from a polished desktop interface.

          > No changes to the desktop app in this release â€” it continues to work exactly as before. The major version bump reflects the addition of the Viewer and Web Proxy companion apps.

          ---

          ### ğŸ“º NEW: ProPresenter Viewer v1.0.0

          **Let your congregation follow along on their own devices.**

          A lightweight menu bar app that streams live slide thumbnails and lyrics to any phone, tablet, or laptop on your Wi-Fi. No app install needed for viewers â€” just open a URL.

          **Highlights:**
          - ğŸ–¼ï¸ Real-time slide thumbnails + lyrics text, pushed via Server-Sent Events
          - ğŸ“± Responsive design optimized for iPad, phones (portrait & landscape), and desktop
          - ğŸ”´ LIVE badge, fullscreen mode, and automatic reconnection
          - ğŸ”„ Smart stay-connected: SSE heartbeat, timeout detection, and page visibility auto-refresh
          - âš™ï¸ Compact settings window â€” configure ProPresenter connection, test, and go
          - ğŸ¯ Zero config for viewers â€” share a URL or QR code, they open it in Safari/Chrome

          **ğŸ“– [Viewer Guide]({DOCS_URL}/guides/viewer)** â€” Full setup walkthrough, sharing tips, and troubleshooting

          ---

          ### ğŸŒ NEW: ProPresenter Web Proxy v1.0.0

          **Access ProPresenter from anywhere â€” securely.**

          A menu bar app that wraps the full web server and Cloudflare Tunnel into a one-click experience. Sign in with Google, manage users, and use the full ProPresenter Lyrics interface from any browser on any network.

          **Highlights:**
          - ğŸ” Google OAuth with email allowlist â€” only approved users can sign in
          - ğŸŒ Cloudflare Tunnel integration â€” no port forwarding, no firewall changes
          - ğŸ–¥ï¸ Full React web UI: playlist browsing, PPTX export with progress streaming, Service Generator
          - ğŸ‘¥ User management from the web UI or CLI
          - ğŸ“Š Structured logging, file-based sessions (6h TTL), auto-restart on crash
          - ğŸ”‘ Bearer token fallback for API access and automation
          - âš™ï¸ Tray menu with start/stop controls for both server and tunnel

          **ğŸ“– [Web Proxy Guide]({DOCS_URL}/guides/proxy-app)** â€” Setup, Google OAuth, Cloudflare Tunnel, and user management

          ---

          ## Downloads

          | App | macOS | Windows | Guide |
          |-----|-------|---------|-------|
          | **ProPresenter Lyrics** v3.0.0 | `ProPresenter-Lyrics-3.0.0-mac.zip` | `ProPresenter-Lyrics-3.0.0-win.exe` | [User Guide]({DOCS_URL}/user-guide) |
          | **ProPresenter Viewer** v1.0.0 | `ProPresenter-Viewer-1.0.0-mac.zip` | `ProPresenter-Viewer-1.0.0-win.exe` | [Viewer Guide]({DOCS_URL}/guides/viewer) |
          | **ProPresenter Web Proxy** v1.0.0 | `ProPresenter-WebProxy-1.0.0-mac.zip` | `ProPresenter-WebProxy-1.0.0-win.exe` | [Proxy Guide]({DOCS_URL}/guides/proxy-app) |

          ### macOS first launch

          macOS may block the app on first run because it's not notarized. Fix with:
          ```bash
          xattr -cr "/Applications/ProPresenter Lyrics.app"
          xattr -cr "/Applications/ProPresenter Viewer.app"
          xattr -cr "/Applications/ProPresenter Web Proxy.app"
          ```

          ---

          ## Requirements

          - **ProPresenter 7** with Network API enabled ([setup instructions]({DOCS_URL}/getting-started#critical-configure-propresenter-first))
          - **macOS** 10.14+ or **Windows** 10+
          - **Viewer**: Devices need a modern browser + same Wi-Fi network
          - **Web Proxy**: A Cloudflare account (free) + domain for remote access

          ---

          ## Documentation

          Full documentation at **[adamswbrown.github.io/propresenterlyricexport]({DOCS_URL})**

          - [Getting Started]({DOCS_URL}/getting-started) â€” Install and connect in 5 minutes
          - [User Guide]({DOCS_URL}/user-guide) â€” Desktop app and CLI workflows
          - [Viewer Guide]({DOCS_URL}/guides/viewer) â€” Live slides for congregation devices
          - [Web Proxy Guide]({DOCS_URL}/guides/proxy-app) â€” Secure remote access
          - [Service Generator]({DOCS_URL}/guides/service-generator) â€” Automate playlists from PDF service orders
          - [PPTX Export]({DOCS_URL}/guides/pptx-export) â€” Customize fonts, colors, and styling
          - [FAQ]({DOCS_URL}/faq) â€” Common questions and troubleshooting

          ---

          **Full changelog:** [CHANGELOG.md](https://github.com/adamswbrown/propresenterlyricexport/blob/main/CHANGELOG.md)
          NOTES_EOF

          # Replace {DOCS_URL} placeholder
          sed -i "s|{DOCS_URL}|${DOCS_URL}|g" release-notes.md

          echo "Release notes generated:"
          wc -l release-notes.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          files: |
            dist/ProPresenter-Lyrics-*-mac.zip
            dist/ProPresenter-Lyrics-*-win.exe
            dist/ProPresenter-Viewer-*-mac.zip
            dist/ProPresenter-Viewer-*-win.exe
            dist/ProPresenter-WebProxy-*-mac.zip
            dist/ProPresenter-WebProxy-*-win.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
